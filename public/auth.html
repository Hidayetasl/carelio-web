<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>Üye Girişi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,Arial,sans-serif;max-width:720px;margin:40px auto;padding:16px}
    h1{margin-bottom:12px}
    input,button{padding:10px;margin:6px 0;width:100%}
    .row{display:flex;gap:8px}
    .row>*{flex:1}
    .muted{color:#666;font-size:12px}
    .btn-google,.btn-facebook{display:inline-block;padding:10px 16px;margin:6px 8px 6px 0;border:1px solid #ddd;border-radius:6px;cursor:pointer}
  </style>
</head>
<body>
  <h1>Üye Girişi</h1>

  <h3>E-posta ile Giriş</h3>
  <form id="login-form">
    <input id="login-email" type="email" placeholder="E-posta" required />
    <input id="login-password" type="password" placeholder="Şifre" required />
    <button type="submit">Giriş Yap</button>
  </form>

  <h3>Üye Ol</h3>
  <form id="register-form">
    <input id="register-email" type="email" placeholder="E-posta" required />
    <input id="register-password" type="password" placeholder="Şifre" required />
    <input id="register-password-confirm" type="password" placeholder="Şifre (tekrar)" required />
    <button type="submit">Üye Ol</button>
  </form>

  <h3>Veya</h3>
  <button class="btn-google">Google ile devam et</button>
  <button class="btn-facebook">Facebook ile devam et</button>

  <p class="muted">
    Girişten sonra: <b>teknik@carelio.com</b> → <code>/uye/</code>, diğer kullanıcılar → <code>/panel.html</code>.<br/>
    Aktif hesabı sıfırlamak için: <a href="/auth.html?logout=1">/auth.html?logout=1</a>
  </p>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signOut,
      signInWithEmailAndPassword, createUserWithEmailAndPassword,
      GoogleAuthProvider, FacebookAuthProvider,
      signInWithPopup, signInWithRedirect, getRedirectResult
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
  apiKey: "AIzaSyDS-Yr56kYNxaLiCYcUapcJYHycy3ITuFY",
  authDomain: "carelio-web.firebaseapp.com",
  projectId: "carelio-web",
  storageBucket: "carelio-web.firebasestorage.app",
  messagingSenderId: "956481490629",
  appId: "1:956481490629:web:c58c873d9d598380492aac"
};
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const google = new GoogleAuthProvider();
    const facebook = new FacebookAuthProvider();

    function routeAfterLogin(email) {
      const e = (email||"").toLowerCase();
      if (e === "teknik@carelio.com") window.location.href = "/uye/";
      else window.location.href = "/panel.html";
    }

    // Redirect dönüşünü yakala (Safari/Opera gibi durumlar için)
    getRedirectResult(auth).then(res => {
      if (res?.user?.email) routeAfterLogin(res.user.email);
    }).catch(()=>{});

    // Oturum açık ise otomatik yönlendir
    onAuthStateChanged(auth, (user) => { if (user?.email) routeAfterLogin(user.email); });

    // Email/şifre giriş
    document.getElementById("login-form").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const email = document.getElementById("login-email").value.trim();
      const pass = document.getElementById("login-password").value;
      try { await signInWithEmailAndPassword(auth, email, pass); routeAfterLogin(auth.currentUser.email); }
      catch(err){ alert("Giriş başarısız: " + (err?.message||err)); }
    });

    // Email/şifre üye ol
    document.getElementById("register-form").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const email = document.getElementById("register-email").value.trim();
      const p1 = document.getElementById("register-password").value;
      const p2 = document.getElementById("register-password-confirm").value;
      if (p1 !== p2) return alert("Şifreler eşleşmiyor");
      try { await createUserWithEmailAndPassword(auth, email, p1); routeAfterLogin(auth.currentUser.email); }
      catch(err){ alert("Kayıt başarısız: " + (err?.message||err)); }
    });

    // Google: popup dene, olmazsa redirect
    document.querySelector(".btn-google").addEventListener("click", async ()=>{
      try { await signInWithPopup(auth, google); routeAfterLogin(auth.currentUser.email); }
      catch { await signInWithRedirect(auth, google); }
    });

    // Facebook: popup → redirect
    document.querySelector(".btn-facebook").addEventListener("click", async ()=>{
      try { await signInWithPopup(auth, facebook); routeAfterLogin(auth.currentUser.email); }
      catch { await signInWithRedirect(auth, facebook); }
    });

    // ?logout=1 ile gelenleri çıkışa zorla
    if (new URLSearchParams(location.search).get("logout") === "1") {
      signOut(auth).then(()=> location.replace("/auth.html"));
    }
  </script>
</body>
</html>
