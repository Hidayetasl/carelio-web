<!doctype html>
<html lang="tr">
<head>
  <meta name="description" content="Carelio – sağlık hizmetleri platformu. Bu sayfaya ait kısa açıklama sonradan özelleştirilecektir.">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carelio – Yönetim Paneli (KB + Döküman)</title>
  <style>
    body{font:15px/1.4 system-ui;margin:0;background:#0f0b1a;color:#f7f7fb}
    header{display:flex;gap:12px;align-items:center;padding:12px 16px;background:#17132a;border-bottom:1px solid #2a2448}
    h1{font-size:18px;margin:0} .wrap{max-width:1024px;margin:0 auto;padding:16px}
    .card{background:#17132a;border:1px solid #2a2448;border-radius:12px;padding:12px;margin:12px 0}
    input,textarea,button,select{background:#221c3d;border:1px solid #2e2951;color:#fff;border-radius:8px;padding:8px}
    label{display:block;margin:8px 0 4px;color:#c8c5d9} button.primary{background:#7b5cf1;border-color:#7b5cf1;cursor:pointer}
    table{width:100%;border-collapse:collapse} th,td{border-bottom:1px solid #2a2448;padding:8px;text-align:left}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .muted{color:#c8c5d9} .ok{color:#3ecf8e} .warn{color:#ffd166}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:800px){.grid{grid-template-columns:1fr}}
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, orderBy, serverTimestamp, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDS-Yr56kYNxaLiCYcUapcJYHycy3ITuFY",
      authDomain: "carelio-web.firebaseapp.com",
      projectId: "carelio-web",
      storageBucket: "carelio-web.firebasestorage.app",
      messagingSenderId: "956481490629",
      appId: "1:956481490629:web:c58c873d9d598380492aac"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Storage fallback
    let st = null;
    let storageTriedFallback = false;
    function getStoragePrimary(){ return getStorage(app); }
    function getStorageFallback(){ return getStorage(app, 'gs://carelio-web.appspot.com'); }

    try { st = getStoragePrimary(); }
    catch(e){ console.warn('Primary storage init hatası, fallback deneniyor...', e); st = getStorageFallback(); storageTriedFallback=true; }

    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('pass');
    const loginBtn = document.getElementById('login');
    const logoutBtn = document.getElementById('logout');
    const meEl = document.getElementById('me');

    const kbQ = document.getElementById('kbQ');
    const kbA = document.getElementById('kbA');
    const kbTags = document.getElementById('kbTags');
    const kbAdd = document.getElementById('kbAdd');
    const kbList = document.getElementById('kbList');

    const fileInput = document.getElementById('file');
    const upBtn = document.getElementById('upload');
    const upProg = document.getElementById('upProg');
    const chList = document.getElementById('chunks');
    const warnEl = document.getElementById('warn');

    if(storageTriedFallback){
      warnEl.textContent = 'Not: Storage config için otomatik fallback kullanılıyor (gs://carelio-web.appspot.com).';
    }

    loginBtn.onclick = async ()=>{ await signInWithEmailAndPassword(auth, emailEl.value, passEl.value); };
    logoutBtn.onclick = ()=> signOut(auth);

    onAuthStateChanged(auth, (user)=>{
      meEl.textContent = user? (user.email + " (giriş)") : "Çıkış";
      document.body.classList.toggle('authed', !!user);
    });

    kbAdd.onclick = async ()=>{
      const q = kbQ.value.trim();
      const a = kbA.value.trim();
      const tags = kbTags.value.trim().split(',').map(s=>s.trim()).filter(Boolean);
      if(!q||!a) return alert('Soru ve cevap gerekli');
      await addDoc(collection(db, 'kb'), { q, a, tags, createdAt: serverTimestamp() });
      kbQ.value = ""; kbA.value = ""; kbTags.value = "";
    };

    onSnapshot(query(collection(db,'kb'), orderBy('createdAt','desc')), (snap)=>{
      kbList.innerHTML = "";
      snap.forEach(docu => {
        const d = docu.data();
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${d.q}</td><td class="muted">${(d.tags||[]).join(', ')}</td>
                         <td class="muted">${(d.a||'').slice(0,80)}...</td>
                         <td><button data-id="${docu.id}" class="del">Sil</button></td>`;
        kbList.appendChild(tr);
      });
      kbList.querySelectorAll('.del').forEach(b=>{
        b.onclick = async ()=> { await deleteDoc(doc(db,'kb',b.dataset.id)); };
      });
    });

    // Yükleme (hata olursa fallback)
    upBtn.onclick = ()=>{
      const f = fileInput.files[0];
      if(!f) return alert('Dosya seçin (PDF/DOCX)');
      let storageRef = null;
      try { storageRef = ref(st, 'docs/' + Date.now() + '-' + f.name); }
      catch(e){
        st = getStorageFallback();
        storageRef = ref(st, 'docs/' + Date.now() + '-' + f.name);
        warnEl.textContent = 'Storage fallback devreye alındı (gs://carelio-web.appspot.com).';
      }
      const task = uploadBytesResumable(storageRef, f);
      task.on('state_changed', s=>{
        const pct = Math.round((s.bytesTransferred / s.totalBytes) * 100);
        upProg.textContent = pct + '%';
      }, err=> {
        if(!storageTriedFallback){
          try{
            st = getStorageFallback();
            storageTriedFallback = true;
            const storageRef2 = ref(st, 'docs/' + Date.now() + '-' + f.name);
            const task2 = uploadBytesResumable(storageRef2, f);
            task2.on('state_changed', s=>{
              const pct = Math.round((s.bytesTransferred / s.totalBytes) * 100);
              upProg.textContent = pct + '% (fallback)';
            }, err2=> alert('Yükleme hatası: ' + err2.message), async ()=>{
              const url = await getDownloadURL(task2.snapshot.ref);
              upProg.textContent = 'Yüklendi ✓ (fallback) ' + url;
              alert('Yükleme (fallback) tamam. Birkaç sn içinde indeks oluşturulacak.');
            });
            return;
          }catch(e2){ }
        }
        alert('Yükleme hatası: ' + err.message);
      }, async ()=>{
        const url = await getDownloadURL(task.snapshot.ref);
        upProg.textContent = 'Yüklendi ✓ ' + url;
        alert('Yükleme tamam. Kısa süre içinde indeks oluşturulacak.');
      });
    };

    onSnapshot(query(collection(db,'chunks'), orderBy('ts','desc')), (snap)=>{
      chList.innerHTML = "";
      snap.forEach(d => {
        const it = d.data();
        const li = document.createElement('li');
        li.innerHTML = `<strong>${it.srcName||'doküman'}</strong> • ${(it.text||'').slice(0,120)}…
                        <div class="muted">${(it.keywords||[]).join(', ')}</div>`;
        chList.appendChild(li);
      });
    });
  </script>
</head>
  <link rel="stylesheet" href="assets/layout.css">
  <script defer src="assets/_layout.js"></script>
<body>
  <header>
    <h1>Carelio Yönetim Paneli</h1>
    <span id="me" class="muted">Çıkış</span>
  </header>
  <div class="wrap">
    <div class="grid">
      <div class="card">
        <h3>Giriş</h3>
        <div class="row">
          <label>E-posta</label><input id="email" placeholder="admin@carelio.com" />
          <label>Şifre</label><input id="pass" type="password" placeholder="••••••••" />
          <button id="login" class="primary">Giriş Yap</button>
          <button id="logout">Çıkış</button>
        </div>
        <div class="muted">Sadece admin e-postalarına yetki verin.</div>
      </div>

      <div class="card">
        <h3>Bilgi Tabanı (Q&A)</h3>
        <label>Soru</label><input id="kbQ" placeholder="Örn: Carelio nedir?" />
        <label>Cevap</label><textarea id="kbA" rows="4" placeholder="Cevabı girin…"></textarea>
        <label>Etiketler (virgülle)</label><input id="kbTags" placeholder="paket,fiyat,doktor" />
        <button id="kbAdd" class="primary">Ekle</button>
        <table>
          <thead><tr><th>Soru</th><th>Etiketler</th><th>Cevap</th><th></th></tr></thead>
          <tbody id="kbList"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h3>Döküman Yükle (PDF / DOCX)</h3>
      <div class="row">
        <input id="file" type="file" accept=".pdf,.doc,.docx" />
        <button id="upload" class="primary">Yükle</button>
        <span id="upProg" class="muted"></span>
      </div>
      <p id="warn" class="warn"></p>
      <p class="muted">Yüklenen dosyalar Cloud Functions tarafından metne çevrilip parçalara ayrılır ve Firestore'a indekslenir.</p>
      <ul id="chunks"></ul>
    </div>
  </div>
</body>
</html>

<!-- audit: 2025-09-06 -->
