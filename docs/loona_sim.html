<script>
  document.getElementById('cbMic').onchange = async (e)=>{
    if(!e.target.checked){ /* kapatƒ±ldƒ± */ return; }
    if(!('webkitSpeechRecognition' in window)) { log('Tarayƒ±cƒ± konu≈üma tanƒ±ma desteklemiyor.'); e.target.checked=false; return; }
    try { await navigator.mediaDevices.getUserMedia({audio:true}); } catch(err){ log('Mikrofon izni verilmedi: ' + err.name); e.target.checked=false; return; }

    const rec = new webkitSpeechRecognition();
    rec.lang='tr-TR'; rec.continuous=true; rec.interimResults=false; rec.maxAlternatives = 3;
    state.mic=true; rec.start(); log('Mikrofon dinleme ba≈üladƒ±.');

    // Yardƒ±mcƒ±lar
    const trFold = {'√ß':'c','ƒü':'g','ƒ±':'i','√∂':'o','≈ü':'s','√º':'u'};
    const norm = s => (s||'').toLowerCase().replace(/[√ßƒüƒ±≈ü√∂√º]/g, m=>trFold[m]).replace(/\s+/g,' ').trim();
    const has = (t, stems) => stems.some(st => t.includes(st));
    const cooldown = {}; const triggerOnce=(name,ms=1200)=>{const now=Date.now(); if(cooldown[name]&&now<cooldown[name])return; cooldown[name]=now+ms; trigger(name);};

    rec.onresult = (ev)=>{
      const res = ev.results[ev.results.length-1];
      const alts = Array.from(res).map(a => (a.transcript||'').trim()).filter(Boolean);
      for (const raw of alts) {
        const text = raw.toLowerCase();
        log('Mikrofon: ' + text);

        // TTS ekosu s√ºresince g√∂rmezden gel
        if (Date.now() < talkMuteUntil) { log('(eko g√∂rmezden gelindi)'); return; }

        const n = norm(text);

        // Evet/Hayƒ±r akƒ±≈üƒ±
        if (pending==='confirm_doctor') {
          if (has(n,['evet','onayliyorum','tamam'])) { pending=null; return triggerOnce('doctor_start'); }
          if (has(n,['hayir','iptal','vazgec']))     { pending=null; speak('ƒ∞ptal edildi.'); return; }
        }

        // Esnek niyet e≈üle≈ütirme (geni≈ületildi)
        if (has(n,['dus','dusme','dustum','yere dus','kaydim','bayildim'])) return triggerOnce('fall');
        if (has(n,['yangin']))                         return triggerOnce('fire');
        if (has(n,['gaz kacak','gaz kacagi','gaz sizinti','gaz koku','gaz'])) return triggerOnce('gas');
        if (has(n,['acil kapi']))                      return triggerOnce('emergency_door');
        if (has(n,[' acil ','acil']))                  return triggerOnce('emergency');
        if (has(n,['misafir','ziyaretci']))            return triggerOnce('visitor');
        if (has(n,['kapiyi ac','kapi ac']))            return triggerOnce('door_open');
        if (has(n,['kapiyi kap','kapi kap']))          return triggerOnce('door_close');
        if (has(n,['isiklari ac','isik ac','aydinlatma ac'])) return triggerOnce('lights_on');
        if (has(n,['isiklari kap','isik kap']))        return triggerOnce('lights_off');
        if (has(n,['hepsini kapat','hepsi kapat','durdur'])) return triggerOnce('all_clear');
        if (has(n,['sabah']))                          return triggerOnce('morning');
        if (has(n,['ilac hatir','ilac saati','ilac'])) return triggerOnce('medicine');

        // üîπ burada yeni formlar eklendi:
        if (has(n,['ilaci aldim','ilac aldim','aldim','alindi'])) return triggerOnce('med_taken');
        if (has(n,['ilac almadim','almadim','atladim','unuttum','alinmadi'])) return triggerOnce('med_skip');

        if (has(n,['doktor gorus','randevu']))        return triggerOnce('doctor_soon');
        if (has(n,['baglanti onay','onayla','baglantiyi onayla'])) return triggerOnce('doctor_confirm');
        if (has(n,['gorusmeyi baslat','gorusmeye basla'])) return triggerOnce('doctor_start');
      }
    };

    // Otomatik yeniden ba≈ülatma (network / no-speech vb.)
    function restart(reason){
      if(!state.mic) return;
      try{ rec.stop(); }catch(_){}
      log('Mikrofon: ' + reason + ' ‚Äì yeniden ba≈ülatƒ±lƒ±yor...');
      setTimeout(()=>{ try{ rec.start(); }catch(_){} }, 300);
    }
    rec.onerror = (err)=>{
      if (['no-speech','network','aborted'].includes(err.error)) restart(err.error);
      else log('Mikrofon hatasƒ±: ' + err.error);
    };
    rec.onend = ()=> restart('bitti');
  };
</script>
<!-- audit: 2025-09-06 -->
