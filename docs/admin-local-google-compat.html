<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Carelio – Admin (Google Compat)</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo="/>
<link rel="stylesheet" href="./style.css"/>
<script src="./config.js"></script>

<!-- Firebase v9 compat (module'siz, klasik kullanım) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
  <link rel="stylesheet" href="assets/layout.css">
  <script defer src="assets/_layout.js"></script>
<body>
  <div id="site-header"></div>
  <div class="container">
    <div class="card">
      <h1>Carelio – Admin (Google Fallback)</h1>
      <div class="flex">
        <button id="signIn">Google ile Giriş</button>
        <button id="signOut" style="background:#374151">Çıkış</button>
        <span id="who" class="small">—</span>
      </div>
      <div id="gate" class="small" style="margin-top:8px;display:block">
        Giriş yapın. Yalnızca yetkili e-postalar: <code>hidayetaslan@gmail.com</code>, <code>mylife.carelio@gmail.com</code>
      </div>

      <div id="app" style="display:none">
        <div class="hr"></div>
        <h2>KB Ekle + Otomatik Chunk</h2>
        <div class="row">
          <div>
            <label>Başlık</label>
            <input id="title" placeholder="Örn. Carelio nedir?"/>
          </div>
          <div>
            <label>Etiketler (virgüllü)</label>
            <input id="tags" placeholder="paket,fiyat,doktor,acil"/>
          </div>
        </div>
        <label>İçerik</label>
        <textarea id="body" rows="8" placeholder="Metni girin..."></textarea>
        <div class="flex">
          <button id="saveKB">Kaydet + Chunkla</button>
          <span id="status" class="small">—</span>
        </div>
        <p class="small">Not: Doküman yükleme (PDF/DOCX) demo paketinde kapalı. Blaze+Storage ile etkinleştirilebilir.</p>
      </div>

      <div id="hint" class="small" style="margin-top:10px;color:#fca5a5"></div>
      <footer>v1.0 • Clean build • Firestore-only (compat)</footer>
    </div>
  </div>

<script>
(function(){
  function $(id){ return document.getElementById(id); }
  function show(t){ var h=$("hint"); if(h) h.textContent=t||""; }

  if (!window.CARELIO_CONFIG){ show("config.js bulunamadı (CARELIO_CONFIG yok)"); return; }

  // Firebase init (compat)
  firebase.initializeApp(window.CARELIO_CONFIG);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  // Persist: local -> session fallback
  auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(function(){
    return auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);
  });

  const ADMIN_EMAILS = {"hidayetaslan@gmail.com":true,"mylife.carelio@gmail.com":true};

  $("signIn").addEventListener("click", function(){
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(function(){
      show("Popup engellendi; yönlendirme ile deniyorum…");
      return auth.signInWithRedirect(provider);
    });
  });

  $("signOut").addEventListener("click", function(){ auth.signOut(); });

  auth.getRedirectResult().then(function(res){
    if (res && res.user) console.log("[ADMIN] Redirect sonrası:", res.user.email);
  }).catch(function(e){
    if (e && e.code === "auth/unauthorized-domain") {
      show("Authorized domains eksik: carelio-web.web.app & firebaseapp.com ekleyin.");
    } else {
      show("Redirect hatası: " + (e && e.code ? e.code : e));
    }
  });

  auth.onAuthStateChanged(function(user){
    if (!user){
      $("gate").style.display = "block";
      $("app").style.display  = "none";
      $("who").textContent = "—";
      return;
    }
    $("who").textContent = user.email || user.uid;
    const allowed = !!ADMIN_EMAILS[(user.email || "").toLowerCase()];
    $("gate").style.display = allowed ? "none" : "block";
    $("app").style.display  = allowed ? "block" : "none";
    if (!allowed) show("Giriş başarılı ama bu hesap yönetici listesinde değil.");
  });

  // Lookbehind'sız chunk bölücü
  function splitIntoChunks(text, size){
    size = size || 600;
    const words = String(text||"").split(/\s+/);
    const parts = []; var buf = "";
    for (var i=0;i<words.length;i++){
      var w = words[i]; var add = (buf ? " " : "") + w;
      if ((buf + add).length > size){ if (buf.trim()) parts.push(buf.trim()); buf = w; }
      else { buf += add; }
    }
    if (buf.trim()) parts.push(buf.trim());
    return parts;
  }

  $("saveKB").addEventListener("click", function(){
    var title = ($("title").value||"").trim();
    var tags  = ($("tags").value ||"").split(",").map(function(s){return s.trim();}).filter(Boolean);
    var body  = ($("body").value ||"").trim();
    if (!title || !body){ show("Başlık ve içerik gerekli."); return; }

    show("Kaydediliyor…");
    db.collection("kb").add({
      title: title, content: body, tags: tags,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(function(kbRef){
      var chunks = splitIntoChunks(body, 600), count = 0, p = Promise.resolve();
      chunks.forEach(function(ch){
        p = p.then(function(){
          count++;
          return db.collection("chunks").add({
            docId: kbRef.id, docTitle: title, text: ch,
            summary: ch.slice(0,160), tags: tags, source:"KB",
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
      });
      return p.then(function(){
        show("KB kaydedildi. " + count + " parça (chunk) oluşturuldu.");
        $("body").value = "";
      });
    }).catch(function(e){
      show("Hata: " + (e && e.message ? e.message : e));
    });
  });
})();
</script>
  <div id="site-footer"></div>
</body>
</html>
<!-- === DOCX YÜKLE (istemci tarafında) === -->
<script src="https://unpkg.com/mammoth@1.6.0/mammoth.browser.min.js"></script>
<div id="docx-uploader" style="margin-top:16px;display:flex;gap:12px;align-items:center;">
  <input id="docxFile" type="file" accept=".docx" />
  <button id="docxToTextarea" type="button" style="padding:8px 12px;border-radius:8px;">DOCX'i İçeriğe Aktar</button>
  <small>.docx seç → İçeriğe aktar → “Kaydet + Chunkla”</small>
</div>
<script>
(function(){
  const fileInput = document.getElementById('docxFile');
  const btn = document.getElementById('docxToTextarea');
  const titleInput = document.querySelector('input,textarea'); // ilk metin girişi "Başlık"
  const tagsInput  = document.querySelectorAll('input')[1];    // ikinci girdi "Etiketler"
  const contentTa  = document.querySelector('textarea');        // büyük "İçerik"

  async function readDocxToText(file){
    const ab = await file.arrayBuffer();
    const res = await window.mammoth.extractRawText({arrayBuffer: ab});
    return (res?.value || '').trim();
  }

  btn?.addEventListener('click', async ()=>{
    const f = fileInput?.files?.[0];
    if(!f){ alert('Lütfen .docx dosyası seçin.'); return; }
    try{
      btn.disabled = true; btn.textContent = 'Dönüştürülüyor...';
      const text = await readDocxToText(f);
      if(!text){ alert('Boş içerik döndü. Dosyayı kontrol edin.'); return; }
      // Başlık ve etiketlere küçük varsayılanlar:
      if(titleInput && !titleInput.value) titleInput.value = f.name.replace(/\.docx$/i,'');
      if(tagsInput && !tagsInput.value)   tagsInput.value   = 'docx,import';
      if(contentTa) contentTa.value = text.slice(0, 500000); // güvenlik için sınırla
      btn.textContent = 'Aktarıldı ✓  (şimdi Kaydet + Chunkla)';
    } catch(e){
      console.error(e); alert('Dönüştürme hatası: ' + e.message);
    } finally { btn.disabled = false; }
  });
})();
</script>
<!-- === /DOCX YÜKLE === -->
