<!doctype html><html lang="tr"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Carelio • Panel</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<style>
:root{--ink:#0f172a;--muted:#64748b}
body{background:#f8fafc}
.btn{border-radius:12px}
.card{border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
.nav-tabs .nav-link{border:none;border-bottom:3px solid transparent;color:#334155}
.nav-tabs .nav-link.active{border-color:#8b5cf6;color:#111827;font-weight:700}
header{background:#0f172a;color:#fff;padding:10px 16px;position:sticky;top:56px;z-index:10;display:flex;align-items:center;justify-content:space-between}
</style>
<!-- Firebase -->
<script defer src="/__/firebase/10.12.2/firebase-app-compat.js"></script>
<script defer src="/__/firebase/10.12.2/firebase-auth-compat.js"></script>
<script defer src="/__/firebase/10.12.2/firebase-firestore-compat.js"></script>
<script defer src="/__/firebase/10.12.2/firebase-storage-compat.js"></script>
<script defer src="/__/firebase/init.js?useEmulator=false"></script>
</head><body>
  <div id="site-header"></div>
  <link rel="stylesheet" href="assets/layout.css">
  <script defer src="assets/_layout.js"></script>

<!-- Üst site menüsü -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/">Carelio</a>
    <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#topnav"><span class="navbar-toggler-icon"></span></button>
    <div id="topnav" class="collapse navbar-collapse">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" href="/index.html">Ana Sayfa</a></li>
        <li class="nav-item"><a class="nav-link" href="/hizmetler.html">Hizmetler</a></li>
        <li class="nav-item"><a class="nav-link" href="/paketler.html">Paketler</a></li>
        <li class="nav-item"><a class="nav-link" href="/teknoloji.html">Teknoloji</a></li>
        <li class="nav-item"><a class="nav-link" href="/hakkimizda.html">Hakkımızda</a></li>
        <li class="nav-item"><a class="nav-link" href="/haberler.html">Haberler</a></li>
        <li class="nav-item"><a class="nav-link" href="/iletisim.html">İletişim</a></li>
      </ul>
      <a class="btn btn-outline-light btn-sm" href="/panel.html">Panel</a>
    </div>
  </div>
</nav>

<header>
  <div class="d-flex align-items-center gap-2"><strong>Carelio</strong><span class="badge bg-secondary">Panel</span></div>
  <div class="d-flex align-items-center gap-2">
    <span id="userName" class="d-none d-md-inline"></span>
    <img id="userPhoto" style="width:32px;height:32px;border-radius:50%" alt="">
    <!-- Link + onclick: JS çalışmasa bile /auth'a gider -->
    <a class="btn btn-sm btn-outline-light" href="./auth.html" onclick="return CARELIO.brutalLogout(event)">Çıkış</a>
  </div>
</header>

<main class="container py-4" style="margin-top:56px">
  <ul class="nav nav-tabs mb-3">
    <li class="nav-item"><a class="nav-link active" data-tab="ozet" href="#ozet">Özet</a></li>
    <li class="nav-item"><a class="nav-link" data-tab="ilaclar" href="#ilaclar">İlaçlar</a></li>
    <li class="nav-item"><a class="nav-link" data-tab="gorusmeler" href="#gorusmeler">Görüşmeler</a></li>
    <li class="nav-item"><a class="nav-link" data-tab="saglik" href="#saglik">Sağlık Verileri</a></li>
    <li class="nav-item"><a class="nav-link" data-tab="kutuphane" href="#kutuphane">Kütüphane</a></li>
    <li class="nav-item"><a class="nav-link" data-tab="profil" href="#profil">Profil</a></li>
  </ul>

  <!-- Özet -->
  <section id="view-ozet">
    <div class="row g-3">
      <div class="col-md-4"><div class="card p-3"><div class="text-muted small">Bugün</div><div class="fs-3 fw-bolder" id="kpiToday">—</div><div class="small text-muted">Planlı hatırlatma / randevu</div></div></div>
      <div class="col-md-4"><div class="card p-3"><div class="text-muted small">İlaç Uyumu</div><div class="fs-3 fw-bolder" id="kpiAdherence">—</div><div class="small text-muted">Son 7 gün</div></div></div>
      <div class="col-md-4"><div class="card p-3"><div class="text-muted small">Son Ölçümler</div><div class="fs-3 fw-bolder" id="kpiVitals">—</div><div class="small text-muted">TA / Nabız / SpO₂</div></div></div>
      <div class="col-md-8"><div class="card p-3"><div class="fw-bold mb-2">Yaklaşan</div><table class="table table-sm" id="tblUpcoming"><thead><tr><th>Tarih</th><th>Tür</th><th>Başlık</th></tr></thead><tbody></tbody></table></div></div>
      <div class="col-md-4"><div class="card p-3"><div class="fw-bold mb-2">Hızlı İşlemler</div>
        <button class="btn btn-outline-primary mb-2" onclick="return CARELIO.quickAppt()">Örnek randevu ekle</button>
        <button class="btn btn-outline-secondary mb-2" data-go="ilaclar">İlaç ekle</button>
        <button class="btn btn-outline-secondary" data-go="saglik">Ölçüm gir</button>
      </div></div>
    </div>
  </section>

  <!-- İlaçlar -->
  <section id="view-ilaclar" class="d-none">
    <div class="row g-3">
      <div class="col-md-7"><div class="card p-3">
        <div class="row g-2 align-items-end">
          <div class="col-md-6"><label class="form-label small">İlaç</label><input id="ilacAd" class="form-control" placeholder="Metformin 500 mg"></div>
          <div class="col-md-3"><label class="form-label small">Sıklık</label><select id="ilacSiklik" class="form-select"><option>Günde 1</option><option>Günde 2</option><option>Günde 3</option></select></div>
          <div class="col-md-3"><label class="form-label small">Saat</label><input id="ilacSaat" type="time" value="09:00" class="form-control"></div>
          <div class="col-12"><button onclick="return CARELIO.addMed()" class="btn btn-primary w-100">Ekle</button></div>
        </div>
        <table class="table table-sm mt-3" id="tblIlac"><thead><tr><th>İlaç</th><th>Sıklık</th><th>Saat</th><th class="text-end">İşlem</th></tr></thead><tbody></tbody></table>
      </div></div>
      <div class="col-md-5"><div class="card p-3"><div class="fw-bold">Bugünkü Hatırlatmalar</div><div id="todayMeds" class="text-muted small">—</div></div></div>
    </div>
  </section>

  <!-- Görüşmeler -->
  <section id="view-gorusmeler" class="d-none">
    <div class="card p-3">
      <div class="row g-2 align-items-end">
        <div class="col-md-5"><label class="form-label small">Başlık</label><input id="gorBaslik" class="form-control" placeholder="Kardiyoloji kontrol"></div>
        <div class="col-md-3"><label class="form-label small">Tarih</label><input id="gorTarih" type="date" class="form-control"></div>
        <div class="col-md-2"><label class="form-label small">Saat</label><input id="gorSaat" type="time" value="10:30" class="form-control"></div>
        <div class="col-md-2"><label class="form-label small">Tür</label><select id="gorTip" class="form-select"><option>Doktor</option><option>Hemşire</option><option>Psikolog</option><option>Diyetisyen</option></select></div>
        <div class="col-12"><button onclick="return CARELIO.addAppt()" class="btn btn-primary w-100">Ekle</button></div>
      </div>
      <table class="table table-sm mt-3" id="tblGorusme"><thead><tr><th>Tarih</th><th>Saat</th><th>Tür</th><th>Başlık</th><th class="text-end">İşlem</th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <!-- Sağlık -->
  <section id="view-saglik" class="d-none">
    <div class="row g-3">
      <div class="col-md-7"><div class="card p-3">
        <div class="row g-2 align-items-end">
          <div class="col-md-4"><label class="form-label small">Tür</label>
            <select id="vitalTip" class="form-select">
              <option value="TA">Tansiyon (mmHg)</option><option value="Nabız">Nabız (bpm)</option>
              <option value="SpO2">SpO₂ (%)</option><option value="Glukoz">Glukoz (mg/dL)</option><option value="Kilo">Kilo (kg)</option>
            </select>
          </div>
          <div class="col-md-5"><label class="form-label small">Değer</label><input id="vitalDeger" class="form-control" placeholder="120/80 veya 75"></div>
          <div class="col-md-3"><button onclick="return CARELIO.addVital()" class="btn btn-primary w-100">Kaydet</button></div>
        </div>
        <table class="table table-sm mt-3" id="tblVitals"><thead><tr><th>Zaman</th><th>Tür</th><th>Değer</th><th class="text-end">İşlem</th></tr></thead><tbody></tbody></table>
      </div></div>
      <div class="col-md-5"><div class="card p-3"><div class="fw-bold">Özet</div><div id="vitalSummary" class="text-muted small">—</div></div></div>
    </div>
  </section>

  <!-- Kütüphane -->
  <section id="view-kutuphane" class="d-none">
    <div class="card p-3">
      <div class="row g-2 align-items-center">
        <div class="col-md-7"><input id="fileInput" class="form-control" type="file" multiple></div>
        <div class="col-md-2"><button onclick="return CARELIO.upload()" class="btn btn-primary w-100">Yükle</button></div>
        <div class="col-md-3"><div class="progress d-none" id="upProgWrap"><div id="upProg" class="progress-bar" role="progressbar" style="width:0%"></div></div></div>
      </div>
      <table class="table table-sm mt-3" id="tblLib"><thead><tr><th>Dosya</th><th>Boyut</th><th>Tarih</th><th class="text-end">İşlem</th></tr></thead><tbody></tbody></table>
      <div class="small text-muted">Dosyalarınız sadece size görünür. (Security Rules gerekli)</div>
    </div>
  </section>

  <!-- Profil -->
  <section id="view-profil" class="d-none"><div class="card p-3">
    <div class="d-flex align-items-center gap-3"><img id="userPhotoBig" style="width:64px;height:64px;border-radius:50%"><div><div id="userNameBig" class="fw-bold"></div><div id="userEmail" class="text-muted small"></div></div></div>
  </div></section>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
window.addEventListener('error',e=>alert('JS Hatası: '+(e.message||e.error)));
window.addEventListener('unhandledrejection',e=>alert('İşlem hatası: '+(e.reason?.message||e.reason)));

// === Tüm fonksiyonlar GLOBAL olsun ===
window.CARELIO = {
  async start(){
    if(!window.firebase) throw new Error('Firebase SDK yok');
    this.auth=firebase.auth(); this.db=firebase.firestore(); this.storage=firebase.storage();
    this.auth.onAuthStateChanged(u=>{
      if(!u){ location.href='/auth'; return; }
      this.user=u; this.hydrate(); this.router(); this.snapshots();
    });
  },
  hydrate(){
    const u=this.user, name=u.displayName||'Kullanıcı';
    const photo=u.photoURL||('https://ui-avatars.com/api/?name='+encodeURIComponent(name)+'&background=8b5cf6&color=fff');
    this.txt('userName',name); this.txt('userNameBig',name); this.txt('userEmail',u.email||'');
    this.img('userPhoto',photo); this.img('userPhotoBig',photo);
  },
  router(){
    const tabs=['ozet','ilaclar','gorusmeler','saglik','kutuphane','profil'];
    const goto=t=>{ tabs.forEach(x=>this.toggle('view-'+x,x===t)); location.hash=t; };
    document.addEventListener('click',e=>{
      const t=e.target.closest('[data-tab]'); if(t){ e.preventDefault(); goto(t.dataset.tab); }
      const g=e.target.closest('[data-go]');  if(g){ goto(g.dataset.go); }
    });
    window.addEventListener('load', ()=> goto((location.hash||'#ozet').replace('#','')) );
  },

  // === GARANTİ ÇIKIŞ ===
  async brutalLogout(ev){
    try{ ev && ev.preventDefault(); }catch(_){}
    try{ await this.auth.signOut(); }catch(_){}
    try{ if(window.indexedDB && indexedDB.deleteDatabase) indexedDB.deleteDatabase('firebaseLocalStorageDb'); }catch(_){}
    try{
      for(const k of Object.keys(localStorage)) if(k.startsWith('firebase:')) localStorage.removeItem(k);
    }catch(_){}
    try{ sessionStorage.clear(); }catch(_){}
    try{ location.replace('/auth'); }catch(_){ location.href='/auth'; }
    return false;
  },

  // === Veri ekleme ===
  async quickAppt(){ const d=new Date(); d.setDate(d.getDate()+1);
    await this.col('appointments').add({baslik:'Kontrol ziyareti', tip:'Doktor', tarih:d.toISOString().slice(0,10), saat:'10:30'});
    alert('Örnek randevu eklendi.'); return false;
  },
  async addMed(){ const ad=val('ilacAd'), sik=val('ilacSiklik'), saat=val('ilacSaat');
    if(!ad) return alert('İlaç adı yazın.'), false;
    await this.col('meds').add({ad:ad,siklik:sik,saat:saat,ts:firebase.firestore.FieldValue.serverTimestamp()}); return false;
  },
  async addAppt(){ const b=val('gorBaslik'), t=val('gorTarih'), s=val('gorSaat'), tip=val('gorTip');
    if(!b||!t) return alert('Başlık ve tarih gerekli.'), false;
    await this.col('appointments').add({baslik:b,tarih:t,saat:s,tip:tip}); return false;
  },
  async addVital(){ const tip=val('vitalTip'), deger=val('vitalDeger');
    if(!tip||!deger) return alert('Tür ve değer gerekli.'), false;
    await this.col('vitals').add({tip:tip,deger:deger,ts:firebase.firestore.FieldValue.serverTimestamp()}); return false;
  },

  // === Dosya yükleme ===
  async upload(){
    const inp=document.getElementById('fileInput');
    if(!inp.files||!inp.files.length) return alert('Dosya seçin.'), false;
    const wrap=gid('upProgWrap'), bar=gid('upProg'); wrap.classList.remove('d-none');
    try{
      for(const f of inp.files){
        const path=`users/${this.user.uid}/library/${Date.now()}-${f.name}`;
        const ref=this.storage.ref().child(path);
        const task=ref.put(f);
        await new Promise((res,rej)=>task.on('state_changed',
          s=>{ bar.style.width=Math.round((s.bytesTransferred/s.totalBytes)*100)+'%'; },
          e=>rej(e),
          ()=>res()
        ));
        const url=await ref.getDownloadURL();
        await this.col('library').add({name:f.name,size:f.size,contentType:f.type||'',url,path,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
      }
      alert('Yükleme tamamlandı.');
    }catch(e){ alert('Yükleme hatası: '+(e?.message||e)); }
    finally{ wrap.classList.add('d-none'); bar.style.width='0%'; inp.value=''; }
    return false;
  },

  // === Canlı listeler ===
  snapshots(){
    this.col('appointments').orderBy('tarih').onSnapshot(s=>{
      const today=new Date().toISOString().slice(0,10);
      const up=s.docs.map(d=>({id:d.id,...d.data()})).filter(a=>a.tarih>=today).slice(0,5);
      this.fill('tblUpcoming', up.map(a=>[this.fd(a.tarih), a.tip, a.baslik]));
      this.txt('kpiToday',`${up.length} öğe`);
    });
    this.col('meds').orderBy('ts','desc').onSnapshot(s=>{
      const meds=s.docs.map(d=>({id:d.id,...d.data()}));
      this.fill('tblIlac', meds.map(m=>[m.ad||'',m.siklik||'',m.saat||'—', this.act('Sil',()=>this.col('meds').doc(m.id).delete())]));
      this.txt('todayMeds', meds.map(m=>(m.saat?m.saat+' • ':'')+m.ad).join(' · ') || 'Bugün için kayıt yok.');
      this.txt('kpiAdherence','%'+Math.min(100,60+Math.floor(Math.random()*40)));
    });
    this.col('vitals').orderBy('ts','desc').onSnapshot(s=>{
      const list=s.docs.map(d=>({id:d.id,...d.data()}));
      this.fill('tblVitals', list.map(v=>[this.fts(v.ts?.toDate?.()||new Date()), v.tip||'', v.deger||'', this.act('Sil',()=>this.col('vitals').doc(v.id).delete())]));
      const ta=list.find(x=>x.tip==='TA'), p=list.find(x=>x.tip==='Nabız'), sp=list.find(x=>x.tip==='SpO2');
      this.txt('kpiVitals', ta?`${ta.tip}: ${ta.deger}` : (list[0]?`${list[0].tip}: ${list[0].deger}`:'—'));
      gid('vitalSummary').innerHTML=`TA: <b>${ta?ta.deger:'—'}</b> · Nabız: <b>${p?p.deger:'—'}</b> · SpO₂: <b>${sp?sp.deger:'—'}</b>`;
    });
    this.col('library').orderBy('createdAt','desc').onSnapshot(s=>{
      const rows=s.docs.map(d=>{const x=d.data();
        return [
          `<a href="${x.url}" target="_blank" rel="noopener">${this.esc(x.name||'Dosya')}</a>`,
          this.human(x.size||0),
          this.fts(x.createdAt?.toDate?.()||new Date()),
          this.act('Sil',()=>this.delFile(d.id,x.path))
        ];
      });
      this.fill('tblLib',rows);
    });
  },
  async delFile(id,path){
    if(!confirm('Silinsin mi?')) return;
    try{ await this.storage.ref().child(path).delete().catch(()=>{}); await this.col('library').doc(id).delete(); }
    catch(e){ alert('Silme hatası: '+(e?.message||e)); }
  },

  // Helpers
  col(c){ return this.db.collection('users').doc(this.user.uid).collection(c); },
  txt(id,t){ const el=document.getElementById(id); if(el) el.textContent=t; },
  img(id,src){ const el=document.getElementById(id); if(el) el.src=src; },
  toggle(id,on){ const el=document.getElementById(id); if(el) el.classList.toggle('d-none',!on); },
  fill(tableId,rows){ const tb=document.querySelector('#'+tableId+' tbody'); if(!tb) return;
    tb.innerHTML=''; rows.forEach(cells=>{ const tr=document.createElement('tr'); cells.forEach((c,i)=>{ const td=document.createElement('td'); if(i===cells.length-1&&String(c).includes('btn')) td.className='text-end'; td.innerHTML=c; tr.appendChild(td); }); tb.appendChild(tr); });
  },
  act(label,fn){ const id='b'+Math.random().toString(36).slice(2,8); setTimeout(()=>{ const el=document.getElementById(id); if(el) el.onclick=fn; },0); return `<button id="${id}" class="btn btn-sm btn-outline-danger">${label}</button>`; },
  pad(n){ return String(n).padStart(2,'0'); },
  fd(s){ const [y,m,d]=s.split('-'); return `${d}.${m}.${y}`; },
  fts(d){ d=new Date(d); return `${this.pad(d.getDate())}.${this.pad(d.getMonth()+1)}.${d.getFullYear()} ${this.pad(d.getHours())}:${this.pad(d.getMinutes())}`; },
  human(b){ if(!b) return '—'; const u=['B','KB','MB','GB']; let i=0; while(b>=1024&&i<u.length-1){ b/=1024;i++; } return b.toFixed(1)+' '+u[i]; },
  esc(s){ return (s||'').replace(/[&<>\"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
};
function gid(id){return document.getElementById(id)} function val(id){return (gid(id)?.value||'')}

document.addEventListener('DOMContentLoaded', ()=> CARELIO.start().catch(e=>alert(e.message||e)));
</script>
<script defer src="/js/drive.js"></script>
  <div id="site-footer"></div>
</body></html>
