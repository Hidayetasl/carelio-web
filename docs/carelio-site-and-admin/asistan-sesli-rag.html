<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carelio ‚Äì Sesli Ziyaret√ßi Asistanƒ± (RAG)</title>
  <style>
    :root{
      --cl-bg:#0f0b1a; --cl-card:#17132a; --cl-acc:#7b5cf1; --cl-acc-2:#9b87ff; --cl-text:#f7f7fb; --cl-dim:#c8c5d9; --cl-ok:#3ecf8e; --radius:16px; --shadow:0 10px 25px rgba(0,0,0,.35);
    }
    html,body{height:100%}
    body{margin:0;background:var(--cl-bg);color:var(--cl-text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    .wrap{max-width:960px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;gap:14px;margin:12px 0 24px}
    .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--cl-acc),var(--cl-acc-2));display:grid;place-items:center;color:#fff;font-weight:700;box-shadow:var(--shadow)}
    h1{font-size:22px;margin:0}
    p.lead{margin:6px 0 0;color:var(--cl-dim)}

    .fab{position:fixed;right:20px;bottom:22px;width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,var(--cl-acc),var(--cl-acc-2));display:grid;place-items:center;cursor:pointer;box-shadow:var(--shadow)}
    .fab:hover{transform:translateY(-2px)}
    .fab svg{width:30px;height:30px;fill:white}

    .chat{position:fixed;right:20px;bottom:96px;width:384px;max-width:calc(100% - 32px);background:var(--cl-card);border:1px solid #2a2448;border-radius:20px;box-shadow:var(--shadow);display:none;flex-direction:column;overflow:hidden}
    .chat.open{display:flex}
    .chat header{padding:14px 16px;border-bottom:1px solid #2a2448;justify-content:space-between}
    .chat header .title{display:flex;gap:10px;align-items:center}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--cl-ok);box-shadow:0 0 0 3px rgba(62,207,142,.15)}
    .chat main{height:420px;overflow:auto;padding:14px;scroll-behavior:smooth}
    .bubble{max-width:86%;padding:10px 12px;margin:8px 0;border-radius:14px}
    .bot{background:#221c3d;border:1px solid #2e2951}
    .me{background:#2e2951;border:1px solid #3b3466;margin-left:auto}
    .msg small{display:block;color:var(--cl-dim);opacity:.8;margin-top:4px}

    .input{display:flex;gap:8px;padding:10px;border-top:1px solid #2a2448;align-items:center}
    .input input{flex:1;background:#221c3d;border:1px solid #2e2951;color:var(--cl-text);border-radius:12px;padding:10px}
    .input button{background:var(--cl-acc);border:none;color:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}

    .settings{display:flex;gap:8px;flex-wrap:wrap;padding:8px 12px;border-top:1px solid #2a2448;background:#1a1532}
    .settings label{font-size:12px;color:var(--cl-dim)}
    select, input[type="checkbox"]{background:#221c3d;border:1px solid #2e2951;color:var(--cl-text);border-radius:8px;padding:6px}

    .kbd{font:12px/1.2 ui-monospace,SFMono-Regular,Menlo,monospace;background:#1e1b2e;border:1px solid #2c2749;border-radius:6px;padding:2px 6px;color:#cfc8ff}
    .note{color:var(--cl-dim);font-size:14px}
    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#201a37;color:#fff;border:1px solid #2a2448;border-radius:10px;padding:8px 12px;display:none}
    .toast.show{display:block}

    @media (max-width:480px){ .chat main{height:58vh} }
  </style>
</head>
  <link rel="stylesheet" href="assets/layout.css">
  <script defer src="assets/_layout.js"></script>
<body>
  <div class="wrap">
    <header>
      <div class="logo">C</div>
      <div>
        <h1>Carelio Sesli Ziyaret√ßi Asistanƒ±</h1>
        <p class="lead">Ziyaret√ßiler <strong>sesli</strong> soru sorar; asistan <strong>sesli</strong> cevap verir. Bilgi kaynaƒüƒ±: Admin panelindeki Q&A + y√ºklenen PDF/DOCX (RAG).</p>
      </div>
    </header>
  </div>

  <!-- Floating Action Button -->
  <button class="fab" id="fab" aria-label="Carelio sohbetini a√ß/kapat">
    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M2 5a3 3 0 0 1 3-3h14a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3H8.9L4.7 20.8A1 1 0 0 1 3 20v-3.2A3 3 0 0 1 2 14V5zm5 3h10v2H7V8zm0 4h7v2H7v-2z"/></svg>
  </button>

  <!-- Chat Panel -->
  <div class="chat" id="chat">
    <header>
      <div class="title"><div class="dot"></div><strong>Carelio Asistan</strong></div>
      <div class="row">
        <button id="micBtn" title="Mikrofonu A√ß/Kapat (Ctrl+M)" style="background:#231e3f;border:1px solid #2f2956;color:#fff;border-radius:12px;padding:8px 12px;cursor:pointer">üéôÔ∏è Dinle</button>
        <button id="closeBtn" class="kbd" title="Kapat">Esc</button>
      </div>
    </header>
    <main id="log" aria-live="polite" aria-label="Sohbet alanƒ±"></main>

    <div class="input">
      <input id="input" type="text" placeholder="Sorunu yaz ya da mikrofona konu≈ü‚Ä¶ (√∂rn. Paketler, Kurulum, Doktor, Fiyat)" autocomplete="off" />
      <button id="send">G√∂nder</button>
    </div>

    <div class="settings">
      <label>
        TTS Ses:
        <select id="voiceSelect"></select>
      </label>
      <label>
        <input type="checkbox" id="autoSpeak" checked /> Cevabƒ± otomatik seslendir
      </label>
      <span class="kbd">Ctrl+M</span> mikrofon ¬∑ <span class="kbd">Enter</span> g√∂nder ¬∑ <span class="kbd">Esc</span> kapat
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script type="module">
    // Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { initClientRAG, answerWithRAG } from "./client-rag.js";

    // === Senin config'in (admin ile aynƒ±) ===
    const firebaseConfig = {
      apiKey: "AIzaSyDS-Yr56kYNxaLiCYcUapcJYHycy3ITuFY",
      authDomain: "carelio-web.firebaseapp.com",
      projectId: "carelio-web",
      storageBucket: "carelio-web.firebasestorage.app",
      messagingSenderId: "956481490629",
      appId: "1:956481490629:web:c58c873d9d598380492aac"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // UI elemanlarƒ±
    const els = {
      fab: document.getElementById('fab'),
      chat: document.getElementById('chat'),
      input: document.getElementById('input'),
      send: document.getElementById('send'),
      log: document.getElementById('log'),
      close: document.getElementById('closeBtn'),
      toast: document.getElementById('toast'),
      micBtn: document.getElementById('micBtn'),
      voiceSelect: document.getElementById('voiceSelect'),
      autoSpeak: document.getElementById('autoSpeak')
    };

    const state = { open:false, listening:false, kb:[], chunks:[], ready:false };

    const toast = (t)=>{ els.toast.textContent=t; els.toast.classList.add('show'); setTimeout(()=>els.toast.classList.remove('show'),1800); };

    const toggle = (open)=>{
      state.open = open ?? !state.open;
      els.chat.classList.toggle('open', state.open);
      if(state.open){ firstOpenIntro(); els.input.focus(); if(!state.ready) bootstrapRAG(); }
    }

    els.fab.addEventListener('click', ()=> toggle());
    els.close.addEventListener('click', ()=> toggle(false));
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && state.open) toggle(false); if(e.ctrlKey && e.key.toLowerCase()==='m'){ e.preventDefault(); toggleMic(); }})

    function addBubble(html, who='bot'){
      const wrap = document.createElement('div');
      wrap.className = `bubble ${who}`;
      wrap.innerHTML = html;
      els.log.appendChild(wrap);
      els.log.scrollTop = els.log.scrollHeight;
    }

    function firstOpenIntro(){
      if(els.log.dataset.init) return;
      els.log.dataset.init = '1';
      addBubble(`<div class="msg">Merhaba! Ben <strong>Carelio Asistan</strong>. Sesli olarak sorabilir, <span class="kbd">Ctrl+M</span> ile mikrofonu a√ßabilirsin. <small>√ñrn: "Paketler", "Kurulum", "Doktor", "Fiyatlar"</small></div>`);
    }

    // === RAG ba≈ülangƒ±cƒ±: KB + chunks √ßek ===
    async function bootstrapRAG(){
      try{
        const { kb, chunks } = await initClientRAG({ getDocs, collection, db });
        state.kb = kb; state.chunks = chunks; state.ready = true;
        addBubble(`<small>Bilgi tabanƒ± y√ºklendi: ${kb.length} Soru‚ÄìCevap, ${chunks.length} d√∂k√ºman par√ßasƒ±.</small>`, 'bot');
      }catch(e){
        addBubble(`<small>Bilgi tabanƒ± y√ºklenemedi. L√ºtfen daha sonra tekrar deneyin.</small>`, 'bot');
      }
    }

    // === Akƒ±llƒ± yanƒ±t ===
    function normalizeTR(s=''){
      return s.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/careli|casrelio|cari?lio|karelio/g,'carelio').trim();
    }

    function answerSmart(userText){
      if(!state.ready){ return '≈ûu anda bilgi tabanƒ±nƒ± y√ºkl√ºyorum, l√ºtfen bir saniye...'; }
      const a = answerWithRAG(userText, state.kb, state.chunks);
      // Anket tetikleme (√∂rnek)
      if(/fiyat|paket|√∂neri|hangisi/.test(normalizeTR(userText))){
        setTimeout(()=>{
          const msg='ƒ∞sterseniz kƒ±sa bir anketle size en uygun paketi netle≈ütirebilirim. Katƒ±lmak ister misiniz? ‚ÄúEvet‚Äù derseniz yeni sekmede a√ßacaƒüƒ±m.';
          addBubble(msg,'bot'); if(els.autoSpeak.checked) speak(msg);
          window.__surveyArmed = true;
        }, 300);
      }
      return a.text;
    }

    // === G√∂nder akƒ±≈üƒ± ===
    async function send(){
      const val = els.input.value.trim();
      if(!val) return;
      addBubble(val, 'me');
      els.input.value = '';

      // Evet ‚Üí anketi a√ß
      if(/^\s*(evet|olur|tamam|kabul|ba≈üla)\s*$/i.test(val) && window.__surveyArmed){
        window.open('https://carelio-web.web.app/anket.html','_blank');
        window.__surveyArmed = false;
        const ok='Te≈üekk√ºrler! Anketi yeni sekmede a√ßtƒ±m.';
        addBubble(ok,'bot'); if(els.autoSpeak.checked) speak(ok);
        return;
      }

      const reply = answerSmart(val);
      addBubble(reply, 'bot');
      if(els.autoSpeak.checked) speak(reply);
    }

    els.send.addEventListener('click', send);
    els.input.addEventListener('keydown', e=>{ if(e.key==='Enter') send(); });

    // === TTS (SpeechSynthesis) ===
    let voices = [];
    function loadVoices(){
      voices = speechSynthesis.getVoices();
      const trVoices = voices.filter(v=> /tr|Turkish/i.test(v.lang));
      const list = trVoices.length? trVoices : voices;
      els.voiceSelect.innerHTML = list.map((v,i)=>`<option value="${voices.indexOf(v)}">${v.name} (${v.lang})</option>`).join('');
    }
    loadVoices();
    if('onvoiceschanged' in speechSynthesis){ speechSynthesis.onvoiceschanged = loadVoices; }

    function speak(text){
      if(!('speechSynthesis' in window)) return toast('Tarayƒ±cƒ± TTS desteklemiyor');
      const u = new SpeechSynthesisUtterance(text.replace(/<[^>]+>/g,' '));
      const idx = parseInt(els.voiceSelect.value,10);
      if(voices[idx]) u.voice = voices[idx];
      u.lang = (u.voice && u.voice.lang) || 'tr-TR';
      u.rate = 1; u.pitch = 1; u.volume = 1;
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }

    // === STT (SpeechRecognition) ===
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    let rec = null;
    if(SR){
      rec = new SR();
      rec.lang = 'tr-TR';
      rec.interimResults = false;
      rec.continuous = false;
      rec.onstart = ()=>{ state.listening = true; els.micBtn.textContent='üü£ Dinleniyor‚Ä¶'; };
      rec.onend = ()=>{ state.listening = false; els.micBtn.textContent='üéôÔ∏è Dinle'; };
      rec.onerror = (e)=>{ toast('Mikrofon hatasƒ±: '+ e.error); };
      rec.onresult = (e)=>{
        const text = Array.from(e.results).map(r=> r[0].transcript).join(' ');
        els.input.value = text;
        send();
      };
    }

    function toggleMic(){
      if(!rec){ toast('Tarayƒ±cƒ± konu≈ümayƒ± tanƒ±ma (STT) desteklemiyor'); return; }
      if(state.listening){ try{ rec.stop(); }catch(_){} return; }
      try{ rec.start(); }catch(err){ toast('Mikrofon ba≈ülatƒ±lamadƒ±'); }
    }

    els.micBtn.addEventListener('click', toggleMic);

    // Hazƒ±r mesaj
    setTimeout(()=>{ toast('Sesli asistan hazƒ±r (Ctrl+M)'); }, 600);
  </script>
</body>
</html>
<!-- audit: 2025-09-06 -->
